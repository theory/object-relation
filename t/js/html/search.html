<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Available instances</title>
    <script type="text/javascript" src="../jsan/JSAN.js"></script>
    <script type="text/javascript">
      function runTest () {
        JSAN.use('Test.More');
        JSAN.includePath = ['../../../www/js'];
        JSAN.use('Kinetic.Search');
        //plan({tests: 15});
        plan({noPlan: true});
        var search = new Kinetic.Search;
        isaOK(search, 'Kinetic.Search');

        diag('canOK(object, method) appears to be broken');
        canOK('Kinetic.Search', '_addToURL')
        var result = search._addToURL('foo','bar');
        is(result, '/foo/bar', '_addToURL should return proper constraints');
        result = search._addToURL('foo','bar baz');
        is(result, '/foo/bar%20baz', '... and they should be URI escaped');
        result = search._addToURL('foo','');
        is(result, '', '... but it should return an empty string if the value is empty');

        result = search._addToURL('search', '');
        is(result, '/search/STRING/null', 'null searches should be handled appropriately');
        result = search._addToURL('search', 'foo');
        is(result, '/search/STRING/foo', '... as should searches with a value');
        result = search._addToURL('search', 'foo => bar');
        is(result, '/search/STRING/foo%20%3D%3E%20bar', '... and they should be properly escaped');

        canOK('Kinetic.Search', 'buildURL');
        var search_form = document.search_form;
        result = search.buildURL(search_form);
        ok(result, '... and calling it with a form should succeed');
        var expected = 'http://www.example.com/rest/one'
          + '/search/STRING/name%20%3D%3E%20%22foo%22%2C%20OR%28name%20%3D%3E%20%22bar%22%29'
          + '/_limit/20'
          + '/_order_by/name'
          + '/_sort_order/ASC?_type=html';
        is(result, expected, '... and it should return the correct url');

        search_form.search.value = '';
        result = search.buildURL(search_form);
        var expected = 'http://www.example.com/rest/one'
          + '/search/STRING/null'
          + '/_limit/20'
          + '/_order_by/name'
          + '/_sort_order/ASC?_type=html';
        is(result, expected, '... even if we have a null search');

        search_form._order_by.value = '';
        result = search.buildURL(search_form);
        var expected = 'http://www.example.com/rest/one'
          + '/search/STRING/null'
          + '/_limit/20?_type=html';
        is(result, expected, '... and it should not have a sort order if the order_by is null');

        search_form._limit.value = '';
        result = search.buildURL(search_form);
        var expected = 'http://www.example.com/rest/one'
          + '/search/STRING/null?_type=html';
        is(result, expected, '... and it should not have a limit if it is null');

        search_form._type.value = '';
        result = search.buildURL(search_form);
        var expected = 'http://www.example.com/rest/one'
          + '/search/STRING/null';
        is(result, expected, '... and it should not have a query string if type is null');

        canOK('Kinetic.Search', '_getSearchString');
        var new_form = document.new_form;
        is( search._getSearchString(new_form),
            'age GT "3", note LIKE "%25foo"',
            '_getSearchString should return the correct search string'
        );

        canOK('Kinetic.Search', '_getComparison');
        var elem = document.new_form._age_comp;
        var results = search._getComparison(elem, 'comp');
        is(results["name"], "age", '... and it should return the name of the property it refers to');
        is(results["value"], "GT", '... and the value of the comparison property');

        elem = document.new_form._age_logical;
        results = search._getComparison(elem, 'logical');
        is(results["name"], "age", '... and a logical comparison should return the property name');
        is(results["value"], "", '... but it should return an empty string if there is no value');

        is(1,1,'force previous failure messages');
      }
    </script>
  </head>
  <body>
    <form method="get" name="new_form" onsubmit="javascript:do_search(this); return false" id="new_form">
      <input type="hidden" name="_class_key" value="one" />
      <input type="hidden" name="_domain"    value="http://www.example.com/" />
      <input type="hidden" name="_path"      value="rest/" />
      <input type="hidden" name="_type"      value="html" />
      <table>
        <tr>
          <td>
            Name:
          </td>
          <td>
            <select name="_name_logical">
              <option value="">is</option>
              <option value="NOT">is not</option>
            </select>
          </td>
          <td>
            <select name="_name_comp">
              <option value="EQ">equal to</option>
              <option value="LIKE">like</option>
              <option value="LT">less than</option>
              <option value="GT">greater than</option>
              <option value="LE">less than or equal</option>
              <option value="GE">greater than or equal</option>
              <option value="NE">not equal</option>
              <option value="BETWEEN">between</option>
              <option value="ANY">any of</option>
            </select>
          </td>
          <td>
            <input type="text" name="name" value="" />
          </td>
        </tr>
        <tr>
          <td>
            Age:
          </td>
          <td>
            <select name="_age_logical">
              <option value="">is</option>
              <option value="NOT">is not</option>
            </select>
          </td>
          <td>
            <select name="_age_comp">
              <option value="EQ">equal to</option>
              <option value="LIKE">like</option>
              <option value="LT">less than</option>
              <option value="GT" selected="selected">greater than</option>
              <option value="LE">less than or equal</option>
              <option value="GE">greater than or equal</option>
              <option value="NE">not equal</option>
              <option value="BETWEEN">between</option>
              <option value="ANY">any of</option>
            </select>
          </td>
          <td>
            <input type="text" name="age" value="3" />
          </td>
        </tr>
        <tr>
          <td>
            Wooble:
          </td>
          <td>
            <select name="_note_logical">
              <option value="">is</option>
              <option value="NOT">is not</option>
            </select>
          </td>
          <td>
            <select name="_note_comp">
              <option value="EQ">equal to</option>
              <option value="LIKE" selected="selected">like</option>
              <option value="LT">less than</option>
              <option value="GT">greater than</option>
              <option value="LE">less than or equal</option>
              <option value="GE">greater than or equal</option>
              <option value="NE">not equal</option>
              <option value="BETWEEN">between</option>
              <option value="ANY">any of</option>
            </select>
          </td>
          <td>
            <input type="text" name="note" value="%foo" />
          </td>
        </tr>
        <tr>
          <td>
            Limit:
          </td>
          <td colspan="3">
            <input type="text" name="_limit" value="20" />
          </td>
        </tr>
        <tr>
          <td>
            Order by:
          </td>
          <td colspan="3">
            <select name="_order_by">
              <option value="name">Name</option>
              <option value="age">Age</option>
              <option value="note">Note</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            Sort Order:
          </td>
          <td colspan="3">
            <select name="_sort_order">
              <option value="ASC">Ascending</option>
              <option value="DESC">Descending</option>
            </select>
          </td>
        </tr>
        <!-- omitting the submit button -->
      </table>
    </form>
    <hr />
    <form method="get" name="search_form" onsubmit="javascript:do_search(this); return false" id="search_form">
      <input type="hidden" name="_class_key" value="one" />
      <input type="hidden" name="_domain"    value="http://www.example.com/" />
      <input type="hidden" name="_path"      value="rest/" />
      <input type="hidden" name="_type"      value="html" />
      <table>
        <tr>
          <td>
            <input type="text" name="search" value="name =&gt; &quot;foo&quot;, OR(name =&gt; &quot;bar&quot;)" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="text" name="_limit" value="20" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="text" name="_order_by" value="name" />
          </td>
        </tr>
        <tr>
          <td>
            <select name="_sort_order">
              <option value="ASC">Ascending</option>
              <option value="DESC">Descending</option>
            </select>
          </td>
        </tr>
        <!-- omitting the submit button -->
      </table>
    </form>
    <!-- the rest of this is not relevant -->
    <pre id="test"><script type="text/javascript">runTest(); </script></pre>
  </body>
</html>
