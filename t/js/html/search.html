<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Available instances</title>
    <script type="text/javascript" src="../jsan/JSAN.js"></script>
    <script type="text/javascript">
function runTest () {
    JSAN.use('Test.More');
    JSAN.includePath = ['../../../www/js'];
    JSAN.use('Kinetic.Search');
    //plan({tests: 15});
    plan({noPlan: true});
    var search = new Kinetic.Search;
    var searchForm = document.search_form;

    isaOK(search, 'Kinetic.Search');

    /**
     * Testing _elemIsArray
     */

    canOK('Kinetic.Search', '_elemIsArray');
    ok(! search._elemIsArray(searchForm['_class_key']),
        '... and single element values should not be identified as arrays');
    ok(search._elemIsArray(searchForm['age']),
        '... but multi-element values should be');

    /**
     * Testing _addToURL
     */

    diag('canOK(object, method) appears to be broken');
    canOK('Kinetic.Search', '_addToURL')
    var result = search._addToURL('foo','bar');
    is(result, '/foo/bar', '_addToURL should return proper constraints');
    result = search._addToURL('foo','bar baz');
    is(result, '/foo/bar%20baz', '... and they should be URI escaped');
    result = search._addToURL('foo','');
    is(result, '', '... but it should return an empty string if the value is empty');

    result = search._addToURL('search', '');
    is(result, '/search/STRING/null', 'null searches should be handled appropriately');
    result = search._addToURL('search', 'foo');
    is(result, '/search/STRING/foo', '... as should searches with a value');
    result = search._addToURL('search', 'foo => bar');
    is(result, escape('/search/STRING/foo => bar'), '... and they should be properly escaped');
    result = search._addToURL('search', '"%25"');
    is(result, escape('/search/STRING/"%25"'), '... and not double-escaped');

    /**
     * Testing _getComparison
     */

    canOK('Kinetic.Search', '_getComparison');
    setOptions(search, {_age_comp: 'GT'});
    var elem = searchForm._age_comp;
    var results = search._getComparison(elem, 'comp');
    is(results["name"], "age", '... and it should return the name of the property it refers to');
    is(results["value"], "GT", '... and the value of the comparison property');

    setOptions(search, {_age_logical: ''});
    elem = searchForm._age_logical;
    results = search._getComparison(elem, 'logical');
    is(results["name"], "age", '... and a logical comparison should return the property name');
    is(results["value"], "", '... but it should return an empty string if there is no value');

    /**
     * Testing _getElemValue
     */

    resetForm(search);
    canOK('Kinetic.Search', '_getElemValue');
    setInputs(search, {age: 17});
    is(search._getElemValue(searchForm['age']), "17",
       '... and we should be able to fetch element values');

    setOptions(search, {_age_comp: 'BETWEEN'});
    setInputs(search, {age: [ 21, 35 ]});
    is(search._getElemValue(searchForm['age']), '[ "21", "35" ]',
        '... and between searches should return a valid BETWEEN value');
    setInputs(search, {age: [ 'foo', 'ba"r' ]});
    //alert("Not yet handling quotes correctly: " + search._getElemValue(searchForm['age']));

    /**
     * Testing _getSearchString
     */

    resetForm(search);
    setInputs(search, { 
        note: '%foo',
        age:  '21'
    } );
    setOptions(search, {
        _age_comp:  'GT',
        _note_comp: 'LIKE'
    });
    canOK('Kinetic.Search', '_getSearchString');
    is( search._getSearchString(searchForm),
        'age GT "21", note LIKE "%foo"',
        '_getSearchString should return the correct search string'
    );

    /**
     * Testing buildURL
     */

    resetForm(search); // reset to default values

    canOK('Kinetic.Search', 'buildURL');
    result = search.buildURL(searchForm);
    ok(result, '... and calling it with a default form should succeed');
    var expected = 'http://www.example.com/rest/one'
        + '/search/STRING/null'
        + '/_limit/20'
        + '/_order_by/name'
        + '/_sort_order/ASC?_type=html';
    is(result, expected, '... and it should return the correct url');

    setInputs(search, { _limit: '0' } );

    result = search.buildURL(searchForm);
    var expected = 'http://www.example.com/rest/one'
        + '/search/STRING/null/_order_by/name/_sort_order/ASC?_type=html';
    is(result, expected, '... and it should not have a limit if it is null');

    setInputs(search, { _type: '' } );

    result = search.buildURL(searchForm);
    var expected = 'http://www.example.com/rest/one'
        + '/search/STRING/null/_order_by/name/_sort_order/ASC';
    is(result, expected, '... and it should not have a query string if type is null');

    setInputs(search, { 
        name:   'Ovid',
        _limit: '20' 
    } );

    var expected = 'http://www.example.com/rest/one'
        + escape('/search/STRING/name EQ "Ovid"')
        + '/_limit/20'
        + '/_order_by/name'
        + '/_sort_order/ASC';
    result = search.buildURL(searchForm);
    is(result, expected, 'Setting a search field should succeed');

    setInputs(search, { name: '%' } );

    var expected = 'http://www.example.com/rest/one'
        + escape('/search/STRING/name EQ "%"')
        + '/_limit/20'
        + '/_order_by/name'
        + '/_sort_order/ASC';
    result = search.buildURL(searchForm);
    is(result, expected, '... and we should not be double-escaping characters');

    setInputs(search, { name:          'Ovid' });
    setOptions(search, { _name_logical: 'NOT' });
    var expected = 'http://www.example.com/rest/one'
        + escape('/search/STRING/name NOT EQ "Ovid"')
        + '/_limit/20'
        + '/_order_by/name'
        + '/_sort_order/ASC';
    result = search.buildURL(searchForm);
    is(result, expected, '... and we should be able to negate the search field');

    setInputs(search, {  name:       '%vid' });
    setOptions(search, { _name_comp: 'LIKE' });
    var expected = 'http://www.example.com/rest/one'
        + escape('/search/STRING/name NOT LIKE "%vid"')
        + '/_limit/20'
        + '/_order_by/name'
        + '/_sort_order/ASC';
    result = search.buildURL(searchForm);
    is(result, expected, '... and set a NOT LIKE value with proper escaping');
    is(1,1,'force previous failure messages');
}

function setInputs(search, valueFor) {
    var searchForm = document.search_form;
    if (valueFor) {
        for (var key in valueFor) {
            var elem = searchForm[key];
            if (! elem) continue;
            if (search._elemIsArray(elem)) {
                if ('BETWEEN' == search.comparisonFor[key]) {
                    elem[1].value = valueFor[key][0];
                    elem[2].value = valueFor[key][1];
                }
                else {
                    elem[0].value = valueFor[key];
                }
            }
            else {
                elem.value = valueFor[key];
            }
        }
    }
}

function setOptions(search, option_for) {
    var searchForm = document.search_form;

    if (option_for) {
        for (var key in option_for) {
            var elem = searchForm[key];
            if (! elem || ! elem.options) continue;
            var option = option_for[key];
            if (key.match(/_comp$/)) {
                var name = key.replace(/^_(\w*)_comp$/, "$1");
                search.comparisonFor[name] = option;
            }
            if ('' == option) {
                elem.selectedIndex = 0;
            }
            else {
                for (var index in elem.options) {
                    if (elem.options[index].value == option) {
                        elem.options[index].selected = true;
                    }
                }
            }
        }
    }
}

function resetForm (search) {
    setInputs(search, { 
        'name'   : '',
        'age'    : '',
        'note'   : '',
        '_limit' : '20'
    });
    setOptions(search, { 
        '_name_logical' : '',
        '_name_comp'    : 'EQ',
        '_age_logical'  : '',
        '_age_comp'     : 'EQ',
        '_note_logical' : '',
        '_note_comp'    : 'EQ',
        '_order_by'     : '',
        '_sort_order'   : 'ASC'
    });
}
    </script>
  </head>
  <body>
    <form method="get" name="search_form" onsubmit="javascript:doSearch(this); return false" id="search_form">
      <input type="hidden" name="_class_key" value="one" />
      <input type="hidden" name="_domain"    value="http://www.example.com/" />
      <input type="hidden" name="_path"      value="rest/" />
      <input type="hidden" name="_type"      value="html" />
      <table>
        <tr>
          <td>
            Name:
          </td>
          <td>
            <select name="_name_logical" id="_name_logical">
              <option value="">is</option>
              <option value="NOT">is not</option>
            </select>
          </td>
          <td>
            <select name="_name_comp" id="_name_comp" onchange="checkForMultiValues(this); return false">
              <option value="EQ">equal to</option>
              <option value="LIKE">like</option>
              <option value="LT">less than</option>
              <option value="GT">greater than</option>
              <option value="LE">less than or equal</option>
              <option value="GE">greater than or equal</option>
              <option value="NE">not equal</option>
              <option value="BETWEEN">between</option>
              <option value="ANY">any of</option>
            </select>
          </td>
          <td>
            <div id="name_not_between" style="display: none">
              <input type="text" name="name" value="" />
            </div>
            <div id="name_between" style="display: block">
              <input type="text" name="name" value="" /> and
              <input type="text" name="name" value="" />
            </div>
          </td>
        </tr>
        <tr>
          <td>
            Age:
          </td>
          <td>
            <select name="_age_logical" id="_age_logical">
              <option value="">is</option>
              <option value="NOT">is not</option>
            </select>
          </td>
          <td>
            <select name="_age_comp" id="_age_comp" onchange="checkForMultiValues(this); return false">
              <option value="EQ">equal to</option>
              <option value="LIKE">like</option>
              <option value="LT">less than</option>
              <option value="GT" selected="selected">greater than</option>
              <option value="LE">less than or equal</option>
              <option value="GE">greater than or equal</option>
              <option value="NE">not equal</option>
              <option value="BETWEEN">between</option>
              <option value="ANY">any of</option>
            </select>
          </td>
          <td>
            <div id="age_not_between" style="display: none">
              <input type="text" name="age" value="5" />
            </div>
            <div id="age_between" style="display: block">
              <input type="text" name="age" value="5" /> and
              <input type="text" name="age" value="" />
            </div>
          </td>
        </tr>
        <tr>
          <td>
            Note:
          </td>
          <td>
            <select name="_note_logical" id="_note_logical">
              <option value="">is</option>
              <option value="NOT">is not</option>
            </select>
          </td>
          <td>
            <select name="_note_comp" id="_note_comp" onchange="checkForMultiValues(this); return false">
              <option value="EQ">equal to</option>
              <option value="LIKE" selected="selected">like</option>
              <option value="LT">less than</option>
              <option value="GT">greater than</option>
              <option value="LE">less than or equal</option>
              <option value="GE">greater than or equal</option>
              <option value="NE">not equal</option>
              <option value="BETWEEN">between</option>
              <option value="ANY">any of</option>
            </select>
          </td>
          <td>
            <div id="note_not_between" style="display: none">
              <input type="text" name="note" value="" />
            </div>
            <div id="note_between" style="display: block">
              <input type="text" name="note" value="" /> and
              <input type="text" name="note" value="" />
            </div>
          </td>
        </tr>
        <tr>
          <td>
            Limit:
          </td>
          <td colspan="3">
            <input type="text" name="_limit" value="20" />
          </td>
        </tr>
        <tr>
          <td>
            Order by:
          </td>
          <td colspan="3">
            <select name="_order_by">
              <option value="name">Name</option>
              <option value="age">Age</option>
              <option value="note">Note</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            Sort Order:
          </td>
          <td colspan="3">
            <select name="_sort_order">
              <option value="ASC">Ascending</option>
              <option value="DESC">Descending</option>
            </select>
          </td>
        </tr>
        <!-- omitting the submit button -->
      </table>
    </form>
    <!-- the rest of this is not relevant -->
    <pre id="test"><script type="text/javascript">runTest(); </script></pre>
  </body>
</html>
